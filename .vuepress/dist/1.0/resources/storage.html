<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Storage | Laravel Vapor</title>
    <meta name="generator" content="VuePress 1.9.7">
    <link href="https://fonts.googleapis.com/css?family=Nunito:200,200i,300,300i,400,400i,600,600i,800,800i,900,900i" rel="stylesheet" type="text/css">
    <meta name="description" content="Laravel at Infinite Scale">
    
    <link rel="preload" href="/assets/css/0.styles.c1eb0935.css" as="style"><link rel="preload" href="/assets/js/app.ab223af1.js" as="script"><link rel="preload" href="/assets/js/2.792bbc0a.js" as="script"><link rel="preload" href="/assets/js/21.72d055f1.js" as="script"><link rel="prefetch" href="/assets/js/10.610ab63b.js"><link rel="prefetch" href="/assets/js/11.0d45e37d.js"><link rel="prefetch" href="/assets/js/12.300d067b.js"><link rel="prefetch" href="/assets/js/13.4e9a9d90.js"><link rel="prefetch" href="/assets/js/14.756798a6.js"><link rel="prefetch" href="/assets/js/15.c0ce5052.js"><link rel="prefetch" href="/assets/js/16.6a0b5690.js"><link rel="prefetch" href="/assets/js/17.d335dd05.js"><link rel="prefetch" href="/assets/js/18.4e60f126.js"><link rel="prefetch" href="/assets/js/19.503256ac.js"><link rel="prefetch" href="/assets/js/20.2c0a75c3.js"><link rel="prefetch" href="/assets/js/22.bfb947e7.js"><link rel="prefetch" href="/assets/js/3.2a93f1b4.js"><link rel="prefetch" href="/assets/js/4.0efab4ce.js"><link rel="prefetch" href="/assets/js/5.6d32f951.js"><link rel="prefetch" href="/assets/js/6.88f97fe0.js"><link rel="prefetch" href="/assets/js/7.a8797844.js"><link rel="prefetch" href="/assets/js/8.381e667c.js"><link rel="prefetch" href="/assets/js/9.2ca5bd96.js">
    <link rel="stylesheet" href="/assets/css/0.styles.c1eb0935.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">Laravel Vapor</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="https://vapor.laravel.com" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Home
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="https://vapor.laravel.com" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Home
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Getting Started</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/1.0/introduction.html" class="sidebar-link">Introduction</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/1.0/introduction.html#what-is-vapor" class="sidebar-link">What Is Vapor?</a></li><li class="sidebar-sub-header"><a href="/1.0/introduction.html#requirements" class="sidebar-link">Requirements</a></li><li class="sidebar-sub-header"><a href="/1.0/introduction.html#account-creation" class="sidebar-link">Account Creation</a></li><li class="sidebar-sub-header"><a href="/1.0/introduction.html#installing-the-vapor-cli" class="sidebar-link">Installing The Vapor CLI</a></li><li class="sidebar-sub-header"><a href="/1.0/introduction.html#installing-the-vapor-core" class="sidebar-link">Installing The Vapor Core</a></li><li class="sidebar-sub-header"><a href="/1.0/introduction.html#installing-the-vapor-ui-dashboard" class="sidebar-link">Installing The Vapor UI Dashboard</a></li><li class="sidebar-sub-header"><a href="/1.0/introduction.html#teams" class="sidebar-link">Teams</a></li><li class="sidebar-sub-header"><a href="/1.0/introduction.html#linking-with-aws" class="sidebar-link">Linking With AWS</a></li><li class="sidebar-sub-header"><a href="/1.0/introduction.html#notification-methods" class="sidebar-link">Notification Methods</a></li></ul></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Projects</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/1.0/projects/the-basics.html" class="sidebar-link">The Basics</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/1.0/projects/the-basics.html#creating-projects" class="sidebar-link">Creating Projects</a></li><li class="sidebar-sub-header"><a href="/1.0/projects/the-basics.html#project-settings" class="sidebar-link">Project Settings</a></li><li class="sidebar-sub-header"><a href="/1.0/projects/the-basics.html#deleting-projects" class="sidebar-link">Deleting Projects</a></li></ul></li><li><a href="/1.0/projects/environments.html" class="sidebar-link">Environments</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/1.0/projects/environments.html#introduction" class="sidebar-link">Introduction</a></li><li class="sidebar-sub-header"><a href="/1.0/projects/environments.html#creating-environments" class="sidebar-link">Creating Environments</a></li><li class="sidebar-sub-header"><a href="/1.0/projects/environments.html#opening-environments" class="sidebar-link">Opening Environments</a></li><li class="sidebar-sub-header"><a href="/1.0/projects/environments.html#environment-variables" class="sidebar-link">Environment Variables</a></li><li class="sidebar-sub-header"><a href="/1.0/projects/environments.html#secrets" class="sidebar-link">Secrets</a></li><li class="sidebar-sub-header"><a href="/1.0/projects/environments.html#vanity-urls" class="sidebar-link">Vanity URLs</a></li><li class="sidebar-sub-header"><a href="/1.0/projects/environments.html#custom-domains" class="sidebar-link">Custom Domains</a></li><li class="sidebar-sub-header"><a href="/1.0/projects/environments.html#maintenance-mode" class="sidebar-link">Maintenance Mode</a></li><li class="sidebar-sub-header"><a href="/1.0/projects/environments.html#commands" class="sidebar-link">Commands</a></li><li class="sidebar-sub-header"><a href="/1.0/projects/environments.html#memory" class="sidebar-link">Memory</a></li><li class="sidebar-sub-header"><a href="/1.0/projects/environments.html#concurrency" class="sidebar-link">Concurrency</a></li><li class="sidebar-sub-header"><a href="/1.0/projects/environments.html#provisioned-concurrency" class="sidebar-link">Provisioned Concurrency</a></li><li class="sidebar-sub-header"><a href="/1.0/projects/environments.html#prewarming" class="sidebar-link">Prewarming</a></li><li class="sidebar-sub-header"><a href="/1.0/projects/environments.html#firewall" class="sidebar-link">Firewall</a></li><li class="sidebar-sub-header"><a href="/1.0/projects/environments.html#timeout" class="sidebar-link">Timeout</a></li><li class="sidebar-sub-header"><a href="/1.0/projects/environments.html#scheduler" class="sidebar-link">Scheduler</a></li><li class="sidebar-sub-header"><a href="/1.0/projects/environments.html#mail" class="sidebar-link">Mail</a></li><li class="sidebar-sub-header"><a href="/1.0/projects/environments.html#metrics" class="sidebar-link">Metrics</a></li><li class="sidebar-sub-header"><a href="/1.0/projects/environments.html#runtime" class="sidebar-link">Runtime</a></li><li class="sidebar-sub-header"><a href="/1.0/projects/environments.html#octane" class="sidebar-link">Octane</a></li><li class="sidebar-sub-header"><a href="/1.0/projects/environments.html#gateway-versions" class="sidebar-link">Gateway Versions</a></li><li class="sidebar-sub-header"><a href="/1.0/projects/environments.html#custom-vpcs" class="sidebar-link">Custom VPCs</a></li><li class="sidebar-sub-header"><a href="/1.0/projects/environments.html#deleting-environments" class="sidebar-link">Deleting Environments</a></li></ul></li><li><a href="/1.0/projects/deployments.html" class="sidebar-link">Deployments</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/1.0/projects/deployments.html#introduction" class="sidebar-link">Introduction</a></li><li class="sidebar-sub-header"><a href="/1.0/projects/deployments.html#initiating-deployments" class="sidebar-link">Initiating Deployments</a></li><li class="sidebar-sub-header"><a href="/1.0/projects/deployments.html#build-hooks" class="sidebar-link">Build Hooks</a></li><li class="sidebar-sub-header"><a href="/1.0/projects/deployments.html#deploy-hooks" class="sidebar-link">Deploy Hooks</a></li><li class="sidebar-sub-header"><a href="/1.0/projects/deployments.html#assets" class="sidebar-link">Assets</a></li><li class="sidebar-sub-header"><a href="/1.0/projects/deployments.html#redeploying" class="sidebar-link">Redeploying</a></li><li class="sidebar-sub-header"><a href="/1.0/projects/deployments.html#rollbacks" class="sidebar-link">Rollbacks</a></li><li class="sidebar-sub-header"><a href="/1.0/projects/deployments.html#deploying-from-ci" class="sidebar-link">Deploying From CI</a></li></ul></li><li><a href="/1.0/projects/development.html" class="sidebar-link">Development</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/1.0/projects/development.html#binary-responses" class="sidebar-link">Binary Responses</a></li><li class="sidebar-sub-header"><a href="/1.0/projects/development.html#configuring-openssl" class="sidebar-link">Configuring OpenSSL</a></li><li class="sidebar-sub-header"><a href="/1.0/projects/development.html#after-response-jobs" class="sidebar-link">&quot;After Response&quot; Jobs</a></li></ul></li><li><a href="/1.0/projects/troubleshooting.html" class="sidebar-link">Troubleshooting</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/1.0/projects/troubleshooting.html#performance-issues" class="sidebar-link">Performance Issues</a></li><li class="sidebar-sub-header"><a href="/1.0/projects/troubleshooting.html#_502-bad-gateway-or-internal-server-error" class="sidebar-link">502 Bad Gateway Or &quot;Internal Server Error&quot;</a></li></ul></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Resources</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/1.0/resources/queues.html" class="sidebar-link">Queues</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/1.0/resources/queues.html#introduction" class="sidebar-link">Introduction</a></li><li class="sidebar-sub-header"><a href="/1.0/resources/queues.html#custom-queue-names" class="sidebar-link">Custom Queue Names</a></li><li class="sidebar-sub-header"><a href="/1.0/resources/queues.html#queue-concurrency" class="sidebar-link">Queue Concurrency</a></li><li class="sidebar-sub-header"><a href="/1.0/resources/queues.html#queue-visibility-timeout" class="sidebar-link">Queue Visibility Timeout</a></li><li class="sidebar-sub-header"><a href="/1.0/resources/queues.html#queue-memory" class="sidebar-link">Queue Memory</a></li><li class="sidebar-sub-header"><a href="/1.0/resources/queues.html#queue-database-connections" class="sidebar-link">Queue Database Connections</a></li><li class="sidebar-sub-header"><a href="/1.0/resources/queues.html#monitoring-jobs" class="sidebar-link">Monitoring Jobs</a></li></ul></li><li><a href="/1.0/resources/storage.html" aria-current="page" class="active sidebar-link">Storage</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/1.0/resources/storage.html#introduction" class="sidebar-link">Introduction</a></li><li class="sidebar-sub-header"><a href="/1.0/resources/storage.html#attaching-storage" class="sidebar-link">Attaching Storage</a></li><li class="sidebar-sub-header"><a href="/1.0/resources/storage.html#mounting-a-persistent-file-system" class="sidebar-link">Mounting A Persistent File System</a></li><li class="sidebar-sub-header"><a href="/1.0/resources/storage.html#file-uploads" class="sidebar-link">File Uploads</a></li><li class="sidebar-sub-header"><a href="/1.0/resources/storage.html#temporary-storage" class="sidebar-link">Temporary Storage</a></li></ul></li><li><a href="/1.0/resources/networks.html" class="sidebar-link">Networks</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/1.0/resources/networks.html#introduction" class="sidebar-link">Introduction</a></li><li class="sidebar-sub-header"><a href="/1.0/resources/networks.html#jumpboxes" class="sidebar-link">Jumpboxes</a></li><li class="sidebar-sub-header"><a href="/1.0/resources/networks.html#nat-gateways" class="sidebar-link">NAT Gateways</a></li><li class="sidebar-sub-header"><a href="/1.0/resources/networks.html#load-balancers" class="sidebar-link">Load Balancers</a></li></ul></li><li><a href="/1.0/resources/databases.html" class="sidebar-link">Databases</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/1.0/resources/databases.html#introduction" class="sidebar-link">Introduction</a></li><li class="sidebar-sub-header"><a href="/1.0/resources/databases.html#creating-databases" class="sidebar-link">Creating Databases</a></li><li class="sidebar-sub-header"><a href="/1.0/resources/databases.html#using-databases" class="sidebar-link">Using Databases</a></li><li class="sidebar-sub-header"><a href="/1.0/resources/databases.html#database-proxies" class="sidebar-link">Database Proxies</a></li><li class="sidebar-sub-header"><a href="/1.0/resources/databases.html#database-users" class="sidebar-link">Database Users</a></li><li class="sidebar-sub-header"><a href="/1.0/resources/databases.html#scaling-databases" class="sidebar-link">Scaling Databases</a></li><li class="sidebar-sub-header"><a href="/1.0/resources/databases.html#restoring-databases" class="sidebar-link">Restoring Databases</a></li><li class="sidebar-sub-header"><a href="/1.0/resources/databases.html#upgrading-databases" class="sidebar-link">Upgrading Databases</a></li><li class="sidebar-sub-header"><a href="/1.0/resources/databases.html#metrics" class="sidebar-link">Metrics</a></li><li class="sidebar-sub-header"><a href="/1.0/resources/databases.html#deleting-databases" class="sidebar-link">Deleting Databases</a></li></ul></li><li><a href="/1.0/resources/caches.html" class="sidebar-link">Caches</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/1.0/resources/caches.html#introduction" class="sidebar-link">Introduction</a></li><li class="sidebar-sub-header"><a href="/1.0/resources/caches.html#creating-caches" class="sidebar-link">Creating Caches</a></li><li class="sidebar-sub-header"><a href="/1.0/resources/caches.html#using-caches" class="sidebar-link">Using Caches</a></li><li class="sidebar-sub-header"><a href="/1.0/resources/caches.html#scaling-caches" class="sidebar-link">Scaling Caches</a></li><li class="sidebar-sub-header"><a href="/1.0/resources/caches.html#metrics" class="sidebar-link">Metrics</a></li><li class="sidebar-sub-header"><a href="/1.0/resources/caches.html#dynamodb-caches" class="sidebar-link">DynamoDB Caches</a></li><li class="sidebar-sub-header"><a href="/1.0/resources/caches.html#deleting-caches" class="sidebar-link">Deleting Caches</a></li></ul></li><li><a href="/1.0/resources/logs.html" class="sidebar-link">Logs</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/1.0/resources/logs.html#introduction" class="sidebar-link">Introduction</a></li><li class="sidebar-sub-header"><a href="/1.0/resources/logs.html#viewing-logs" class="sidebar-link">Viewing Logs</a></li></ul></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Domains</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/1.0/domains/dns.html" class="sidebar-link">DNS</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/1.0/domains/dns.html#introduction" class="sidebar-link">Introduction</a></li><li class="sidebar-sub-header"><a href="/1.0/domains/dns.html#creating-dns-zones" class="sidebar-link">Creating DNS Zones</a></li><li class="sidebar-sub-header"><a href="/1.0/domains/dns.html#nameservers" class="sidebar-link">Nameservers</a></li><li class="sidebar-sub-header"><a href="/1.0/domains/dns.html#managing-dns-records" class="sidebar-link">Managing DNS Records</a></li><li class="sidebar-sub-header"><a href="/1.0/domains/dns.html#deleting-zones" class="sidebar-link">Deleting Zones</a></li></ul></li><li><a href="/1.0/domains/certificates.html" class="sidebar-link">Certificates</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/1.0/domains/certificates.html#introduction" class="sidebar-link">Introduction</a></li><li class="sidebar-sub-header"><a href="/1.0/domains/certificates.html#creating-certificates" class="sidebar-link">Creating Certificates</a></li><li class="sidebar-sub-header"><a href="/1.0/domains/certificates.html#deleting-certificates" class="sidebar-link">Deleting Certificates</a></li></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="storage"><a href="#storage" class="header-anchor">#</a> Storage</h1> <p></p><div class="table-of-contents"><ul><li><a href="#introduction">Introduction</a></li><li><a href="#attaching-storage">Attaching Storage</a></li><li><a href="#mounting-a-persistent-file-system">Mounting A Persistent File System</a></li><li><a href="#file-uploads">File Uploads</a><ul><li><a href="#installing-the-vapor-npm-package">Installing The Vapor NPM Package</a></li><li><a href="#authorization">Authorization</a></li><li><a href="#streaming-files-to-s3">Streaming Files To S3</a></li><li><a href="#acknowledge-file-uploads-permanent-storage">Acknowledge File Uploads &amp; Permanent Storage</a></li></ul></li><li><a href="#temporary-storage">Temporary Storage</a></li></ul></div><p></p> <h2 id="introduction"><a href="#introduction" class="header-anchor">#</a> Introduction</h2> <p>When running an application in a serverless environment, you may not store files permanently on the local filesystem, since you can never be sure that the same serverless &quot;container&quot; will be used on a subsequent request. All files should be stored in a cloud storage system, such as AWS S3, or in a shared file system through AWS EFS.</p> <h2 id="attaching-storage"><a href="#attaching-storage" class="header-anchor">#</a> Attaching Storage</h2> <p>To ensure that an application environment has a place to store file uploads, you may add a <code>storage</code> key to the environment's <code>vapor.yml</code> configuration. This value should be a valid S3 bucket name. During deployment, Vapor will ensure that this bucket exists. If the bucket does not exist, Vapor will create and configure it. Remember, bucket names must be unique across all of AWS:</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">id</span><span class="token punctuation">:</span> <span class="token number">3</span>
<span class="token key atrule">name</span><span class="token punctuation">:</span> vapor<span class="token punctuation">-</span>app
<span class="token key atrule">environments</span><span class="token punctuation">:</span>
    <span class="token key atrule">production</span><span class="token punctuation">:</span>
        <span class="token key atrule">storage</span><span class="token punctuation">:</span> my<span class="token punctuation">-</span>bucket<span class="token punctuation">-</span>name
        <span class="token key atrule">memory</span><span class="token punctuation">:</span> <span class="token number">1024</span>
        <span class="token key atrule">build</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> <span class="token string">'composer install --no-dev'</span>
        <span class="token key atrule">deploy</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> <span class="token string">'php artisan migrate --force'</span>
</code></pre></div><h2 id="mounting-a-persistent-file-system"><a href="#mounting-a-persistent-file-system" class="header-anchor">#</a> Mounting A Persistent File System</h2> <p>To mount a file system on your Lambda, you need to <a href="/1.0/resources/networks.html#introduction">attach your environment to a Vapor network</a> and then create a new elastic file system (EFS) using the AWS console. In the EFS dashboard, you should click the &quot;Create file system&quot; button and choose the VPC created by your Vapor network. Once the file system is created, click on its name to access the configuration screen and then click on &quot;Access Points&quot;. Create an access point and specify <code>1001</code> for the user and group of both the &quot;POSIX user&quot; and &quot;Root directory creation permissions&quot; settings. For the &quot;Root directory path&quot; configuration option, you should assign a unique name such as <code>/{project_name}_{environment_name}</code>.</p> <p>After creating the disk, you should navigate to the AWS Lambda dashboard. Once in the Lambda dashboard, locate each of the three Lambda functions (the primary function, the &quot;cli&quot; function, and the &quot;queue&quot; function) for your project environment and attach the file system you just created. You may attach the file system by viewing the Lambda function's detail page and clicking the &quot;Add file system&quot; button. You should mount the file system to <code>/mnt/local</code>.</p> <p>Once mounted, you can store and retrieve files to the <code>/mnt/local</code> disk path. This path will be shared and accessible by all three of the Lambda functions.</p> <h2 id="file-uploads"><a href="#file-uploads" class="header-anchor">#</a> File Uploads</h2> <p>Due to AWS Lambda limitations, file uploads made directly to your application backend can only be up to roughly 4.5MB in size. This is a hard limit imposed by AWS, and updating the <code>php.ini</code> configuration file or any other configuration will not raise this limit. Therefore, to ensure your application's users won't receive an <code>HTTP 413 Payload Too Large</code> response, you may validate the file upload size using JavaScript before initiating the file upload to your application's backend.</p> <p>If your application needs to receive file uploads larger than AWS allows, those files must be streamed directly to S3 from your application's frontend (Browser). To assist you, we've written an NPM package that makes it easy to perform file uploads directly from your application's frontend.</p> <h3 id="installing-the-vapor-npm-package"><a href="#installing-the-vapor-npm-package" class="header-anchor">#</a> Installing The Vapor NPM Package</h3> <p>To get started, install the <code>laravel-vapor</code> NPM package:</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">npm</span> <span class="token function">install</span> --save-dev laravel-vapor
</code></pre></div><p>Next, within your application's <code>app.js</code> file, initialize the global Vapor JavaScript object:</p> <div class="language-js extra-class"><pre class="language-js"><code>window<span class="token punctuation">.</span>Vapor <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'laravel-vapor'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="authorization"><a href="#authorization" class="header-anchor">#</a> Authorization</h3> <p>Before initiating an upload directly to S3, Vapor's internal signed storage URL generator will perform an authorization check against the currently authenticated user. If you do not already have one, you should create a <code>UserPolicy</code> for your application using the following command:</p> <div class="language-bash extra-class"><pre class="language-bash"><code>php artisan make:policy UserPolicy --model<span class="token operator">=</span>User
</code></pre></div><p>Next, you should add an <code>uploadFiles</code> method to this policy. This method should return <code>true</code> if the given authenticated user is allowed to upload files. Otherwise, you should return <code>false</code>:</p> <div class="language-php extra-class"><pre class="language-php"><code><span class="token comment">/**
 * Determine whether the user can upload files.
 *
 * @param  \App\User  $user
 * @return mixed
 */</span>
<span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">uploadFiles</span><span class="token punctuation">(</span><span class="token class-name type-declaration">User</span> <span class="token variable">$user</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token constant boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="streaming-files-to-s3"><a href="#streaming-files-to-s3" class="header-anchor">#</a> Streaming Files To S3</h3> <p>You may use the <code>Vapor.store</code> method within your frontend code to upload a file directly to the S3 bucket attached to your environment. The following example demonstrates this functionality using Vue:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token operator">&lt;</span>input type<span class="token operator">=</span><span class="token string">&quot;file&quot;</span> id<span class="token operator">=</span><span class="token string">&quot;file&quot;</span> ref<span class="token operator">=</span><span class="token string">&quot;file&quot;</span><span class="token operator">&gt;</span>

Vapor<span class="token punctuation">.</span><span class="token function">store</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>$refs<span class="token punctuation">.</span>file<span class="token punctuation">.</span>files<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token function-variable function">progress</span><span class="token operator">:</span> <span class="token parameter">progress</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>uploadProgress <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">round</span><span class="token punctuation">(</span>progress <span class="token operator">*</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">response</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    axios<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/api/profile-photo'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">uuid</span><span class="token operator">:</span> response<span class="token punctuation">.</span>uuid<span class="token punctuation">,</span>
        <span class="token literal-property property">key</span><span class="token operator">:</span> response<span class="token punctuation">.</span>key<span class="token punctuation">,</span>
        <span class="token literal-property property">bucket</span><span class="token operator">:</span> response<span class="token punctuation">.</span>bucket<span class="token punctuation">,</span>
        <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>$refs<span class="token punctuation">.</span>file<span class="token punctuation">.</span>files<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>name<span class="token punctuation">,</span>
        <span class="token literal-property property">content_type</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>$refs<span class="token punctuation">.</span>file<span class="token punctuation">.</span>files<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>type<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>All uploaded files will be placed in a <code>tmp</code> directory within the bucket. <strong>This directory is automatically configured to purge any files older than 24 hours.</strong> This feature serves to conveniently clean up file uploads that are initiated but not completed, such as a user that begins updating their profile photo but does not save the change.</p> <p>The <code>tmp</code> directory is private by default. To override this for a given file you may add a <code>visibility</code> property to the options provided to the <code>Vapor.store</code> method. The <code>visibility</code> property should be assigned one of <a href="https://docs.aws.amazon.com/AmazonS3/latest/dev/acl-overview.html#canned-acl" target="_blank" rel="noopener noreferrer">S3's predefined permission grants<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>:</p> <div class="language-js extra-class"><pre class="language-js"><code>Vapor<span class="token punctuation">.</span><span class="token function">store</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>$refs<span class="token punctuation">.</span>file<span class="token punctuation">.</span>files<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">visibility</span><span class="token operator">:</span> <span class="token string">'public-read'</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">response</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="acknowledge-file-uploads-permanent-storage"><a href="#acknowledge-file-uploads-permanent-storage" class="header-anchor">#</a> Acknowledge File Uploads &amp; Permanent Storage</h3> <p>All uploaded files will be stored using a UUID as their filename. The <code>response</code> provided to the <code>store</code> method's <code>then</code> callback will contain the UUID of the file, the file's full S3 key, and the file's bucket. You may then POST this information to your application's backend to permanently store the file by moving it out of the bucket's <code>tmp</code> directory. In addition, you may wish to store additional information about the file, such as its original name and content type, in your application's database:</p> <div class="language-php extra-class"><pre class="language-php"><code><span class="token keyword">use</span> <span class="token package">Illuminate<span class="token punctuation">\</span>Support<span class="token punctuation">\</span>Facades<span class="token punctuation">\</span>Storage</span><span class="token punctuation">;</span>

<span class="token class-name static-context">Storage</span><span class="token operator">::</span><span class="token function">copy</span><span class="token punctuation">(</span>
    <span class="token variable">$request</span><span class="token operator">-&gt;</span><span class="token function">input</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'key'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">str_replace</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'tmp/'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">''</span><span class="token punctuation">,</span> <span class="token variable">$request</span><span class="token operator">-&gt;</span><span class="token function">input</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'key'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h4 id="local-development"><a href="#local-development" class="header-anchor">#</a> Local Development</h4> <p>When developing locally, <code>Vapor.store</code> will upload to the bucket specified by the <code>AWS_BUCKET</code> environment variable. In addition, your bucket may require CORS configuration to allow uploads from localhost:</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">[</span>
   <span class="token punctuation">{</span>
      <span class="token property">&quot;AllowedHeaders&quot;</span><span class="token operator">:</span><span class="token punctuation">[</span>
         <span class="token string">&quot;*&quot;</span>
      <span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token property">&quot;AllowedMethods&quot;</span><span class="token operator">:</span><span class="token punctuation">[</span>
         <span class="token string">&quot;GET&quot;</span><span class="token punctuation">,</span>
         <span class="token string">&quot;PUT&quot;</span>
      <span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token property">&quot;AllowedOrigins&quot;</span><span class="token operator">:</span><span class="token punctuation">[</span>
         <span class="token string">&quot;*&quot;</span>
      <span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token property">&quot;ExposeHeaders&quot;</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token punctuation">]</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">]</span>
</code></pre></div><h2 id="temporary-storage"><a href="#temporary-storage" class="header-anchor">#</a> Temporary Storage</h2> <p>Your application may store temporary files within the <code>/tmp</code> directory. By default, this directory has a fixed size of 512 MB, and the information on it is preserved for the lifetime of each request, CLI command, or queue job. You may increase or decrease the configured temporary storage size using the <code>tmp-storage</code>, <code>cli-tmp-storage</code>, and <code>queue-tmp-storage</code> options in your environment's <code>vapor.yml</code> configuration. These configuration options accept values between 512 MB and 10,240 MB:</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">id</span><span class="token punctuation">:</span> <span class="token number">2</span>
<span class="token key atrule">name</span><span class="token punctuation">:</span> vapor<span class="token punctuation">-</span>laravel<span class="token punctuation">-</span>app
<span class="token key atrule">environments</span><span class="token punctuation">:</span>
    <span class="token key atrule">production</span><span class="token punctuation">:</span>
        <span class="token key atrule">tmp-storage</span><span class="token punctuation">:</span> <span class="token number">1024</span>
        <span class="token key atrule">cli-tmp-storage</span><span class="token punctuation">:</span> <span class="token number">512</span>
        <span class="token key atrule">queue-tmp-storage</span><span class="token punctuation">:</span> <span class="token number">10240</span>
        <span class="token key atrule">build</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> <span class="token string">'composer install --no-dev'</span>
</code></pre></div></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/1.0/resources/queues.html" class="prev">
        Queues
      </a></span> <span class="next"><a href="/1.0/resources/networks.html">
        Networks
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.ab223af1.js" defer></script><script src="/assets/js/2.792bbc0a.js" defer></script><script src="/assets/js/21.72d055f1.js" defer></script>
  </body>
</html>
